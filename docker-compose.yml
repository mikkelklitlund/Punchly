services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: punchly_db
    restart: always
    environment:
      ACCEPT_EULA: 'Y'
      MSSQL_SA_PASSWORD: ${DB_PASSWORD:-YourStrong@Passw0rd}
      MSSQL_PID: ${MSSQL_PID:-Developer}
    volumes:
      - punchly_db_data:/var/opt/mssql
    ports:
      - '6500:1433'
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${DB_PASSWORD:-YourStrong@Passw0rd}" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: punchly:latest
    container_name: punchly_api
    restart: always
    depends_on:
      - db
    environment:
      NODE_ENV: production
      DATABASE_URL: sqlserver://db:1433;database=${DB_NAME:-punchly};user=sa;password=${DB_PASSWORD:-YourStrong@Passw0rd};encrypt=true;trustServerCertificate=true

      CLIENT_URL: ${CLIENT_URL:-http://localhost:4000}
      PORT: 4000
      TZ: UTC
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-secret}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-secret}
    ports:
      - '4000:4000'
    volumes:
      - punchly_uploads:/app/backend/uploads

volumes:
  punchly_db_data:
    driver: local
  punchly_uploads:
    driver: local
